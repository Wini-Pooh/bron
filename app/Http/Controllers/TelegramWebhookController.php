<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use App\Models\Company;
use App\Models\Appointment;
use App\Services\TelegramBotService;
use Carbon\Carbon;

class TelegramWebhookController extends Controller
{
    protected $botService;

    public function __construct(TelegramBotService $botService)
    {
        $this->botService = $botService;
    }

    /**
     * ะะฑัะฐะฑะพััะธะบ webhook ะพั Telegram
     */
    public function handle(Request $request, $botToken)
    {
        try {
            // ะะฐะนัะธ ะบะพะผะฟะฐะฝะธั ะฟะพ ัะพะบะตะฝั ะฑะพัะฐ
            $company = Company::where('telegram_bot_token', $botToken)->first();
            
            if (!$company) {
                Log::warning('ะะพะปััะตะฝ webhook ะดะปั ะฝะตะธะทะฒะตััะฝะพะณะพ ะฑะพัะฐ', ['token' => $botToken]);
                return response('OK', 200);
            }

            $update = $request->all();
            Log::info('ะะพะปััะตะฝ Telegram webhook', [
                'company_id' => $company->id,
                'update' => $update
            ]);

            // ะะฑัะฐะฑะพัะบะฐ callback query (ะฝะฐะถะฐัะธะต ะบะฝะพะฟะพะบ)
            if (isset($update['callback_query'])) {
                $this->handleCallbackQuery($company, $update['callback_query']);
            }
            
            // ะะฑัะฐะฑะพัะบะฐ ะพะฑััะฝัั ัะพะพะฑัะตะฝะธะน
            if (isset($update['message'])) {
                $this->handleMessage($company, $update['message']);
            }

            return response('OK', 200);
            
        } catch (\Exception $e) {
            Log::error('ะัะธะฑะบะฐ ะพะฑัะฐะฑะพัะบะธ Telegram webhook', [
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);
            return response('Error', 500);
        }
    }

    /**
     * ะะฑัะฐะฑะพัะบะฐ callback query (ะฝะฐะถะฐัะธะต ะบะฝะพะฟะพะบ)
     */
    private function handleCallbackQuery($company, $callbackQuery)
    {
        $chatId = $callbackQuery['from']['id'];
        $messageId = $callbackQuery['message']['message_id'];
        $data = $callbackQuery['data'];

        // ะะฐััะธะผ ะดะฐะฝะฝัะต callback
        $parts = explode(':', $data);
        $action = $parts[0];

        switch ($action) {
            case 'select_date':
                $date = $parts[1];
                $this->showTimeSlots($company, $chatId, $messageId, $date);
                break;
                
            case 'select_time':
                $date = $parts[1];
                $time = $parts[2];
                $this->showServiceSelection($company, $chatId, $messageId, $date, $time);
                break;
                
            case 'select_service':
                $date = $parts[1];
                $time = $parts[2];
                $serviceId = $parts[3];
                $this->showContactForm($company, $chatId, $messageId, $date, $time, $serviceId);
                break;
                
            case 'confirm_booking':
                $this->processBooking($company, $callbackQuery);
                break;
                
            case 'cancel_booking':
                $this->cancelBooking($company, $chatId, $messageId);
                break;
        }

        // ะัะฒะตัะฐะตะผ ะฝะฐ callback query
        $this->botService->answerCallbackQuery($company, $callbackQuery['id']);
    }

    /**
     * ะะฑัะฐะฑะพัะบะฐ ะพะฑััะฝัั ัะพะพะฑัะตะฝะธะน
     */
    private function handleMessage($company, $message)
    {
        $chatId = $message['from']['id'];
        $text = $message['text'] ?? '';
        
        Log::info('ะะฑัะฐะฑะพัะบะฐ ัะพะพะฑัะตะฝะธั ะพั ะฟะพะปัะทะพะฒะฐัะตะปั', [
            'company_id' => $company->id,
            'chat_id' => $chatId,
            'text' => $text
        ]);

        if ($text === '/start' || $text === '/book') {
            $this->showWelcomeMessage($company, $chatId);
        } elseif ($text === '/help') {
            $this->showHelpMessage($company, $chatId);
        } elseif ($text === '/cancel') {
            $this->showCancelOptions($company, $chatId);
        } else {
            // ะัะพะฒะตััะตะผ, ะพะถะธะดะฐะตััั ะปะธ ะฒะฒะพะด ะบะพะฝัะฐะบัะฝัั ะดะฐะฝะฝัั
            $this->handleContactInput($company, $chatId, $text);
        }
    }

    /**
     * ะะพะบะฐะทัะฒะฐะตั ะฟัะธะฒะตัััะฒะตะฝะฝะพะต ัะพะพะฑัะตะฝะธะต ั ะบะฐะปะตะฝะดะฐัะตะผ
     */
    private function showWelcomeMessage($company, $chatId)
    {
        $message = "๐ข ะะพะฑัะพ ะฟะพะถะฐะปะพะฒะฐัั ะฒ {$company->name}!\n\n";
        $message .= "๐ ะัะฑะตัะธัะต ัะดะพะฑะฝัั ะดะฐัั ะดะปั ะทะฐะฟะธัะธ:";

        $keyboard = $this->botService->createDateKeyboard($company);
        
        $this->botService->sendMessage($company, $chatId, $message, [
            'reply_markup' => json_encode(['inline_keyboard' => $keyboard])
        ]);
    }

    /**
     * ะะพะบะฐะทัะฒะฐะตั ะดะพัััะฟะฝัะต ะฒัะตะผะตะฝะฝัะต ัะปะพัั
     */
    private function showTimeSlots($company, $chatId, $messageId, $date)
    {
        $slots = $this->botService->getAvailableTimeSlots($company, $date);
        
        if (empty($slots)) {
            $message = "โ ะะฐ ะฒัะฑัะฐะฝะฝัั ะดะฐัั ({$date}) ะฝะตั ัะฒะพะฑะพะดะฝะพะณะพ ะฒัะตะผะตะฝะธ.\n\nะัะฑะตัะธัะต ะดััะณัั ะดะฐัั:";
            $keyboard = $this->botService->createDateKeyboard($company);
        } else {
            $message = "๐ ะัะฑะตัะธัะต ัะดะพะฑะฝะพะต ะฒัะตะผั ะฝะฐ {$date}:";
            $keyboard = $this->botService->createTimeKeyboard($date, $slots);
        }

        $this->botService->editMessage($company, $chatId, $messageId, $message, [
            'reply_markup' => json_encode(['inline_keyboard' => $keyboard])
        ]);
    }

    /**
     * ะะพะบะฐะทัะฒะฐะตั ะฒัะฑะพั ััะปัะณะธ
     */
    private function showServiceSelection($company, $chatId, $messageId, $date, $time)
    {
        $services = $company->services()->where('is_active', true)->get();
        
        $message = "๐ผ ะัะฑะตัะธัะต ััะปัะณั ะฝะฐ {$date} ะฒ {$time}:";
        $keyboard = $this->botService->createServiceKeyboard($date, $time, $services);

        $this->botService->editMessage($company, $chatId, $messageId, $message, [
            'reply_markup' => json_encode(['inline_keyboard' => $keyboard])
        ]);
    }

    /**
     * ะะพะบะฐะทัะฒะฐะตั ัะพัะผั ะดะปั ะฒะฒะพะดะฐ ะบะพะฝัะฐะบัะพะฒ
     */
    private function showContactForm($company, $chatId, $messageId, $date, $time, $serviceId)
    {
        $service = $company->services()->find($serviceId);
        
        $message = "โ๏ธ ะะฐะฝะฝัะต ะทะฐะฟะธัะธ:\n\n";
        $message .= "๐ ะะฐัะฐ: {$date}\n";
        $message .= "๐ ะัะตะผั: {$time}\n";
        $message .= "๐ผ ะฃัะปัะณะฐ: {$service->name}\n";
        $message .= "๐ฐ ะกัะพะธะผะพััั: {$service->formatted_price}\n\n";
        $message .= "ะะพะถะฐะปัะนััะฐ, ะพัะฟัะฐะฒััะต ะฒะฐัะธ ะบะพะฝัะฐะบัะฝัะต ะดะฐะฝะฝัะต ะฒ ัะพัะผะฐัะต:\n";
        $message .= "ะะผั ะคะฐะผะธะปะธั\n+7 (XXX) XXX-XX-XX\nemail@example.com (ะฝะตะพะฑัะทะฐัะตะปัะฝะพ)";

        // ะกะพััะฐะฝัะตะผ ะดะฐะฝะฝัะต ะฒ ัะตััะธะธ (ะผะพะถะฝะพ ะธัะฟะพะปัะทะพะฒะฐัั Redis ะธะปะธ ะะ)
        cache()->put("booking_data_{$chatId}", [
            'date' => $date,
            'time' => $time,
            'service_id' => $serviceId,
            'step' => 'waiting_contact'
        ], 1800); // 30 ะผะธะฝัั

        $this->botService->editMessage($company, $chatId, $messageId, $message);
    }

    /**
     * ะะฑัะฐะฑะฐััะฒะฐะตั ะฒะฒะพะด ะบะพะฝัะฐะบัะฝัั ะดะฐะฝะฝัั
     */
    private function handleContactInput($company, $chatId, $text)
    {
        $bookingData = cache()->get("booking_data_{$chatId}");
        
        if (!$bookingData || $bookingData['step'] !== 'waiting_contact') {
            return;
        }

        // ะะฐััะธะผ ะบะพะฝัะฐะบัะฝัะต ะดะฐะฝะฝัะต
        $lines = explode("\n", trim($text));
        $name = $lines[0] ?? '';
        $phone = $lines[1] ?? '';
        $email = $lines[2] ?? '';

        // ะะฐะปะธะดะฐัะธั
        if (empty($name) || empty($phone)) {
            $this->botService->sendMessage($company, $chatId, 
                "โ ะะพะถะฐะปัะนััะฐ, ัะบะฐะถะธัะต ะธะผั ะธ ัะตะปะตัะพะฝ ะฒ ะฟัะฐะฒะธะปัะฝะพะผ ัะพัะผะฐัะต.");
            return;
        }

        // ะกะพััะฐะฝัะตะผ ะบะพะฝัะฐะบัะฝัะต ะดะฐะฝะฝัะต
        $bookingData['name'] = $name;
        $bookingData['phone'] = $phone;
        $bookingData['email'] = $email;
        $bookingData['step'] = 'confirm';
        
        cache()->put("booking_data_{$chatId}", $bookingData, 1800);

        // ะะพะบะฐะทัะฒะฐะตะผ ะฟะพะดัะฒะตัะถะดะตะฝะธะต
        $this->showBookingConfirmation($company, $chatId, $bookingData);
    }

    /**
     * ะะพะบะฐะทัะฒะฐะตั ะฟะพะดัะฒะตัะถะดะตะฝะธะต ะทะฐะฟะธัะธ
     */
    private function showBookingConfirmation($company, $chatId, $bookingData)
    {
        $service = $company->services()->find($bookingData['service_id']);
        
        $message = "โ ะะพะดัะฒะตัะดะธัะต ะทะฐะฟะธัั:\n\n";
        $message .= "๐ค ะะปะธะตะฝั: {$bookingData['name']}\n";
        $message .= "๐ ะขะตะปะตัะพะฝ: {$bookingData['phone']}\n";
        if (!empty($bookingData['email'])) {
            $message .= "๐ง Email: {$bookingData['email']}\n";
        }
        $message .= "๐ ะะฐัะฐ: {$bookingData['date']}\n";
        $message .= "๐ ะัะตะผั: {$bookingData['time']}\n";
        $message .= "๐ผ ะฃัะปัะณะฐ: {$service->name}\n";
        $message .= "๐ฐ ะกัะพะธะผะพััั: {$service->formatted_price}";

        $keyboard = [
            [
                ['text' => 'โ ะะพะดัะฒะตัะดะธัั', 'callback_data' => 'confirm_booking'],
                ['text' => 'โ ะัะผะตะฝะธัั', 'callback_data' => 'cancel_booking']
            ]
        ];

        $this->botService->sendMessage($company, $chatId, $message, [
            'reply_markup' => json_encode(['inline_keyboard' => $keyboard])
        ]);
    }

    /**
     * ะะฑัะฐะฑะฐััะฒะฐะตั ะฟะพะดัะฒะตัะถะดะตะฝะธะต ะทะฐะฟะธัะธ
     */
    private function processBooking($company, $callbackQuery)
    {
        $chatId = $callbackQuery['from']['id'];
        $bookingData = cache()->get("booking_data_{$chatId}");
        
        if (!$bookingData) {
            $this->botService->sendMessage($company, $chatId, 
                "โ ะะฐะฝะฝัะต ะทะฐะฟะธัะธ ัััะฐัะตะปะธ. ะะพะถะฐะปัะนััะฐ, ะฝะฐัะฝะธัะต ะทะฐะฝะพะฒะพ ั /start");
            return;
        }

        try {
            // ะกะพะทะดะฐะตะผ ะทะฐะฟะธัั
            $appointment = Appointment::create([
                'company_id' => $company->id,
                'service_id' => $bookingData['service_id'],
                'client_name' => $bookingData['name'],
                'client_phone' => $bookingData['phone'],
                'client_email' => $bookingData['email'],
                'appointment_date' => $bookingData['date'],
                'appointment_time' => $bookingData['time'],
                'duration_minutes' => $company->services()->find($bookingData['service_id'])->duration_minutes,
                'status' => 'pending',
                'notes' => 'ะะฐะฟะธัั ัะตัะตะท Telegram-ะฑะพั'
            ]);

            // ะัะธัะฐะตะผ ะบัั
            cache()->forget("booking_data_{$chatId}");

            $message = "๐ ะะฐะฟะธัั ััะฟะตัะฝะพ ัะพะทะดะฐะฝะฐ!\n\n";
            $message .= "๐ ะะพะผะตั ะทะฐะฟะธัะธ: #{$appointment->id}\n";
            $message .= "๐ ะะฐัะฐ: {$appointment->formatted_date}\n";
            $message .= "๐ ะัะตะผั: {$appointment->formatted_time}\n\n";
            $message .= "๐ ะั ัะฒัะถะตะผัั ั ะฒะฐะผะธ ะดะปั ะฟะพะดัะฒะตัะถะดะตะฝะธั.\n\n";
            $message .= "ะะปั ะฝะพะฒะพะน ะทะฐะฟะธัะธ ะพัะฟัะฐะฒััะต /start";

            $this->botService->editMessage($company, $chatId, $callbackQuery['message']['message_id'], $message);

            // ะัะฟัะฐะฒะปัะตะผ ัะฒะตะดะพะผะปะตะฝะธะต ะฒะปะฐะดะตะปััั
            if ($company->telegram_notifications_enabled && $company->telegram_chat_id) {
                $ownerMessage = "๐ ะะพะฒะฐั ะทะฐะฟะธัั ัะตัะตะท Telegram-ะฑะพั!\n\n";
                $ownerMessage .= "๐ค ะะปะธะตะฝั: {$appointment->client_name}\n";
                $ownerMessage .= "๐ ะขะตะปะตัะพะฝ: {$appointment->client_phone}\n";
                $ownerMessage .= "๐ ะะฐัะฐ: {$appointment->formatted_date}\n";
                $ownerMessage .= "๐ ะัะตะผั: {$appointment->formatted_time}\n";
                $ownerMessage .= "๐ผ ะฃัะปัะณะฐ: {$appointment->service->name}";

                $this->botService->sendMessage($company, $company->telegram_chat_id, $ownerMessage);
            }

        } catch (\Exception $e) {
            Log::error('ะัะธะฑะบะฐ ัะพะทะดะฐะฝะธั ะทะฐะฟะธัะธ ัะตัะตะท Telegram', [
                'error' => $e->getMessage(),
                'booking_data' => $bookingData
            ]);

            $this->botService->sendMessage($company, $chatId, 
                "โ ะัะพะธะทะพัะปะฐ ะพัะธะฑะบะฐ ะฟัะธ ัะพะทะดะฐะฝะธะธ ะทะฐะฟะธัะธ. ะะพะถะฐะปัะนััะฐ, ะฟะพะฟัะพะฑัะนัะต ะฟะพะทะถะต ะธะปะธ ัะฒัะถะธัะตัั ั ะฝะฐะผะธ ะฝะฐะฟััะผัั.");
        }
    }

    /**
     * ะัะผะตะฝัะตั ะฟัะพัะตัั ะทะฐะฟะธัะธ
     */
    private function cancelBooking($company, $chatId, $messageId)
    {
        cache()->forget("booking_data_{$chatId}");
        
        $message = "โ ะะฐะฟะธัั ะพัะผะตะฝะตะฝะฐ.\n\nะะปั ะฝะพะฒะพะน ะทะฐะฟะธัะธ ะพัะฟัะฐะฒััะต /start";
        
        $this->botService->editMessage($company, $chatId, $messageId, $message);
    }

    /**
     * ะะพะบะฐะทัะฒะฐะตั ัะฟัะฐะฒะพัะฝัั ะธะฝัะพัะผะฐัะธั
     */
    private function showHelpMessage($company, $chatId)
    {
        $message = "โน๏ธ ะกะฟัะฐะฒะบะฐ ะฟะพ ะฑะพัั {$company->name}\n\n";
        $message .= "ะะพัััะฟะฝัะต ะบะพะผะฐะฝะดั:\n";
        $message .= "/start ะธะปะธ /book - ะะฐะฟะธัะฐัััั ะฝะฐ ะฟัะธะตะผ\n";
        $message .= "/help - ะะพะบะฐะทะฐัั ััั ัะฟัะฐะฒะบั\n";
        $message .= "/cancel - ะัะผะตะฝะธัั ัะตะบัััั ะพะฟะตัะฐัะธั\n\n";
        $message .= "๐ ะะพะฝัะฐะบัั:\n";
        if ($company->phone) {
            $message .= "ะขะตะปะตัะพะฝ: {$company->phone}\n";
        }
        if ($company->email) {
            $message .= "Email: {$company->email}\n";
        }
        if ($company->address) {
            $message .= "ะะดัะตั: {$company->address}\n";
        }

        $this->botService->sendMessage($company, $chatId, $message);
    }

    /**
     * ะะพะบะฐะทัะฒะฐะตั ะพะฟัะธะธ ะพัะผะตะฝั ะทะฐะฟะธัะธ
     */
    private function showCancelOptions($company, $chatId)
    {
        // ะะดะตัั ะผะพะถะฝะพ ะดะพะฑะฐะฒะธัั ััะฝะบัะธะพะฝะฐะป ะพัะผะตะฝั ัััะตััะฒัััะธั ะทะฐะฟะธัะตะน
        $message = "ะะปั ะพัะผะตะฝั ะทะฐะฟะธัะธ, ะฟะพะถะฐะปัะนััะฐ, ัะฒัะถะธัะตัั ั ะฝะฐะผะธ:\n\n";
        if ($company->phone) {
            $message .= "๐ ะขะตะปะตัะพะฝ: {$company->phone}\n";
        }
        if ($company->email) {
            $message .= "๐ง Email: {$company->email}";
        }

        $this->botService->sendMessage($company, $chatId, $message);
    }
}
